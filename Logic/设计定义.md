# VideoTranslate 项目执行步骤文档

## 概述

VideoTranslate 是一个完整的视频翻译解决方案，支持从视频导入到最终导出的全流程处理。本文档详细说明项目的执行步骤、每个步骤的要求以及验证方法。

---

## 执行步骤总览

0.下载视频
从youtube下载视频。

1. 导入视频
将本地的视频导入视频到项目中。

方法定义:
VideoProjectInstance.ImportVideo(videoPath,其他参数可以是有默认值的);

2.音频分离
从视频中分离出音频
方法定义:
VideoProjectInstance.ExtractAudio(audioPath);

3. 语音识别
使用whisper.cpp识别音频，保存为srt
方法定义:
VideoProjectInstance.RecognizeAudio(audioPath,其他参数可以是有默认值的);

3. 翻译字幕
使用lmstudio api翻译字幕，每30条为一批。
方法定义:
VideoProjectInstance.TranslateSubtitles(srtPath,其他参数可以是有默认值的);

4. 生成 TTS 音频 ✅ 已实现
使用index tts api进行生成中文音频
**实现状态：已完成**

**实现内容：**
- ✅ 创建了TTSServiceManager服务管理器，支持启动多个TTS API服务
- ✅ 实现了服务健康检测机制，验证每个服务是否成功启动
- ✅ 修改了TTSService以支持并行调用多个TTS服务
- ✅ 实现了任务分发机制，将TTS任务分配给多个服务
- ✅ 创建了启动脚本，支持在不同GPU和端口上启动多个服务
- ✅ 更新了VideoEditorService以集成新的多服务TTS功能

**使用方法：**

1. 启动多个TTS服务：
```bash
# 启动5个服务（默认）
startAllTtsServices.bat

# 启动3个服务
startAllTtsServices.bat 3
```

2. 使用并行TTS生成音频：
```bash
VideoTranslate.exe tts-parallel MyProject.json
```

**新增文件：**
- [TTSServiceInstance.cs](file:///d:/index-tts/VideoTranslate/Models/TTSServiceInstance.cs) - TTS服务实例模型
- [ITTSServiceManager.cs](file:///d:/index-tts/VideoTranslate/Interfaces/ITTSServiceManager.cs) - 服务管理器接口
- [TTSServiceManager.cs](file:///d:/index-tts/VideoTranslate/Services/TTSServiceManager.cs) - 服务管理器实现
- [startAllTtsServices.bat](file:///d:/index-tts/startAllTtsServices.bat) - 启动多个TTS服务的脚本
- [startTtsService.bat](file:///d:/index-tts/startTtsService.bat) - 启动单个TTS服务的脚本
- [并行TTS服务使用指南.md](file:///d:/index-tts/VideoTranslate/并行TTS服务使用指南.md) - 详细使用文档

**修改的文件：**
- [ITTSService.cs](file:///d:/index-tts/VideoTranslate/Interfaces/ITTSService.cs) - 添加了并行生成方法
- [TTSService.cs](file:///d:/index-tts/VideoTranslate/Services/TTSService.cs) - 实现了并行生成逻辑
- [IVideoEditorService.cs](file:///d:/index-tts/VideoTranslate/Interfaces/IVideoEditorService.cs) - 添加了并行TTS方法
- [VideoEditorService.cs](file:///d:/index-tts/VideoTranslate/Services/VideoEditorService.cs) - 集成了并行TTS功能
- [ServiceCollectionExtensions.cs](file:///d:/index-tts/VideoTranslate/Utils/ServiceCollectionExtensions.cs) - 注册了服务管理器
- [Program.cs](file:///d:/index-tts/VideoTranslate/Program.cs) - 添加了tts-parallel命令

**特性：**
- ✅ 支持启动任意数量的TTS服务实例
- ✅ **自动检测系统可用的GPU（使用nvidia-smi）**
- ✅ **自动检测端口占用情况**
- ✅ **自动检测已运行的TTS服务**
- ✅ **如果没有运行的服务，自动启动**
- ✅ 服务健康检测和状态监控
- ✅ 负载均衡（自动将任务分配给最空闲的服务）
- ✅ 并行处理，显著提高生成速度
- ✅ 支持跳过已存在的音频文件
- ✅ 详细的日志和统计信息

**自动检测流程：**
1. 使用 `nvidia-smi` 检测系统可用的GPU
2. 检查端口8000、8001、8002等是否被占用
3. 如果端口已被TTS服务占用，直接使用该服务
4. 如果端口可用，自动启动新的TTS服务
5. 验证服务健康状态
6. 开始并行生成音频

**使用方式：**
```bash
# 方式一：自动检测和启动（推荐）
# 系统会自动检测GPU和端口，并启动所需的TTS服务
VideoTranslate.exe tts-parallel MyProject.json

# 方式二：手动启动服务
startAllTtsServices.bat 5
VideoTranslate.exe tts-parallel MyProject.json
```

**性能提升：**
假设有100条字幕需要生成：
- 单服务：约100分钟
- 3个服务并行：约35分钟
- 5个服务并行：约20分钟


5. 音频对齐与合并
应该以英文srt的时间为“主时间轴”，以它为准，来调整中文音频。
先将英文音频做为背景音频，把中文音频片断放到英文音频的对应的时间点上。
对于每个 中文片断来讲，如果它比英文短，就直接放到英文音频的对应时间点上。
如果它比英文长，则需要将中文音频的片断调整为与英文音频相同的时长。

6. 验证音频对齐与合并是否正确
使用whisper.cpp 对合并后的音频进行识别，
与原始的中文srt文件进行对比，验证对齐是否正确。

7. 导出视频
将处理后的视频导出到本地文件系统。
增加字幕轨道，包含英文和中文字幕。
