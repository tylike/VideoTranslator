# 轨道和片段上下文菜单系统设计文档

## 概述

轨道上下文菜单系统是一个基于特性的菜单生成机制，允许开发者通过在 TrackInfo 及其派生类的方法上添加 `[ContextMenuAction]` 特性，自动为轨道生成右键菜单项。

片段上下文菜单系统是轨道上下文菜单系统的扩展，允许开发者通过在 Clip 及其派生类的方法上添加 `[ContextMenuAction]` 特性，自动为片段生成右键菜单项。

## 设计目标

1. **声明式编程**：通过特性声明菜单项，无需手动创建菜单
2. **自动发现**：使用反射自动发现标记的方法
3. **类型安全**：编译时检查，避免运行时错误
4. **灵活扩展**：支持分组、排序、图标等配置
5. **基类支持**：支持从基类继承的菜单方法

## 核心组件

### 1. ContextMenuAction 特性

位置：`d:\VideoTranslator\IProgress\ContextMenuActionAttribute.cs`

```csharp
[AttributeUsage(AttributeTargets.Method, AllowMultiple = false)]
public class ContextMenuActionAttribute : Attribute
{
    public string DisplayName { get; }           // 菜单项显示文本（必需）
    public string? Icon { get; set; }          // 菜单项图标（可选）
    public string? Group { get; set; }         // 菜单项分组名称（可选）
    public int Order { get; set; }             // 菜单项排序顺序（可选）
    public bool IsEnabled { get; set; }        // 是否启用（可选，默认为 true）
    public bool IsAutoCommit { get; set; }      // 执行后是否自动提交更改（可选，默认为 false）
}
```

### 2. TrackContextMenuFactory 工厂类

位置：`d:\VideoTranslator\TimeLine\Controls\TrackContextMenuFactory.cs`

职责：
- 使用反射扫描 TrackInfo 对象的所有公共方法
- 查找标记了 `[ContextMenuAction]` 特性的方法
- 根据特性属性创建对应的菜单项
- 支持分组和排序
- 支持同步和异步方法

### 3. ClipContextMenuFactory 工厂类

位置：`d:\VideoTranslator\TimeLine\Controls\ClipContextMenuFactory.cs`

职责：
- 使用反射扫描 Clip 对象的所有公共方法
- 查找标记了 `[ContextMenuAction]` 特性的方法
- 根据特性属性创建对应的菜单项
- 支持分组和排序
- 支持同步和异步方法

### 4. SimpleSegmentControl 扩展

位置：`d:\VideoTranslator\TimeLine\Controls\SimpleSegmentControl.cs`

新增属性：
```csharp
public TimeLineViewModel? ViewModel { get; set; }
```

用于支持传递 TimeLineViewModel 参数到菜单方法。

新增事件：
```csharp
private void OnRightButtonUp(object sender, MouseButtonEventArgs e)
```

用于显示右键上下文菜单。

### 5. SimpleTrackControl 扩展

位置：`d:\VideoTranslator\TimeLine\Controls\SimpleTrackControl.cs`

新增属性：
```csharp
public TimeLineViewModel? ViewModel { get; set; }
```

用于将 TimeLineViewModel 传递给片段控件。

### 6. TimeLineViewModel 扩展

位置：`d:\VideoTranslator\TimeLine\ViewModels\TimeLineViewModel.cs`

新增属性：
```csharp
public IObjectSpace? ObjectSpace { get; set; }
```

用于支持自动提交功能和传递 IObjectSpace 参数。

## 使用方法

### 轨道菜单基本用法

在 TrackInfo 的任何子类中，只需在方法上添加 `[ContextMenuAction]` 特性：

```csharp
public class SRTTrackInfo : TrackInfo
{
    [ContextMenuAction("翻译字幕", Order = 10, Group = "翻译")]
    public async Task TranslateSubtitle()
    {
        // 实现翻译逻辑
    }
}
```

### 支持的方法参数

系统支持以下参数类型：

1. **无参数**
```csharp
[ContextMenuAction("播放音频")]
public void PlayAudio()
{
    // 实现
}
```

2. **TimeLineViewModel 参数**
```csharp
[ContextMenuAction("导出数据")]
public void ExportData(TimeLineViewModel viewModel)
{
    // 使用 viewModel
}
```

3. **IObjectSpace 参数**
```csharp
[ContextMenuAction("保存轨道信息")]
public void SaveTrackInfo(IObjectSpace objectSpace)
{
    // 使用 objectSpace
    objectSpace.CommitChanges();
}
```

### 自动提交更改

设置 `IsAutoCommit = true`，方法执行后会自动调用 `ObjectSpace.CommitChanges()`：

```csharp
[ContextMenuAction("删除轨道", Order = 100, IsAutoCommit = true)]
public void DeleteTrack()
{
    // 修改数据
    this.VideoProject.Tracks.Remove(this);
    // 方法执行完后会自动调用 ObjectSpace.CommitChanges()
}
```

### 分组和排序

```csharp
[ContextMenuAction("翻译字幕", Order = 10, Group = "翻译")]
public async Task TranslateSubtitle()
{
}

[ContextMenuAction("使用LMStudio翻译字幕", Order = 20, Group = "翻译")]
public async Task TranslateWithLMStudio()
{
}

[ContextMenuAction("生成TTS音频", Order = 30, Group = "音频")]
public async Task GenerateTTS()
{
}

[ContextMenuAction("导出为SRT文件", Order = 40, Group = "导出")]
public async Task ExportSrt()
{
}
```

菜单会按以下规则显示：
- 按 `Group` 分组显示
- 按 `Order` 排序（越小越靠前）
- 不同分组之间会自动添加分隔线

### 基类继承

在基类中定义的菜单方法会被所有子类继承：

```csharp
// 在 TrackInfo 基类中
public abstract class TrackInfo : VTBaseObject
{
    [ContextMenuAction("复制轨道信息", Order = 100, Group = "通用")]
    public void CopyTrackInfo()
    {
        // 通用实现
    }
}

// 在 SRTTrackInfo 子类中
public class SRTTrackInfo : TrackInfo
{
    [ContextMenuAction("翻译字幕", Order = 10, Group = "翻译")]
    public async Task TranslateSubtitle()
    {
        // 特定实现
    }
}
```

`SRTTrackInfo` 的菜单会同时显示：
- "翻译字幕"（来自子类）
- "复制轨道信息"（来自基类）

## 初始化设置

在使用前，需要确保 `TimeLineViewModel.ObjectSpace` 属性已经被正确设置：

```csharp
// 在 MainWindow.xaml.cs 中
public partial class MainWindow : WpfWindow
{
    private IObjectSpace? _objectSpace;

    private void InitializeTimeLine()
    {
        // 创建 ViewModel
        var viewModel = new TimeLineViewModel();
        
        // 设置 ObjectSpace
        viewModel.ObjectSpace = _objectSpace;
        
        // 绑定到 UI
        timeLinePanel.ViewModel = viewModel;
    }
}
```

## 已实现的菜单方法

### SRTTrackInfo

| 方法名 | 显示文本 | 分组 | 排序 | 说明 |
|--------|----------|------|------|------|
| TranslateSubtitle | 翻译字幕 | 翻译 | 10 | 使用Google翻译API翻译字幕 |
| TranslateWithLMStudio | 使用LMStudio翻译字幕 | 翻译 | 20 | 使用LMStudio翻译API翻译字幕 |
| GenerateTTS | 生成TTS音频 | 音频 | 30 | 为SRT字幕生成TTS音频 |
| ExportSrt | 导出为SRT文件 | 导出 | 40 | 导出为SRT文件 |

### AudioTrackInfo

| 方法名 | 显示文本 | 分组 | 排序 | 说明 |
|--------|----------|------|------|------|
| PlayAudio | 播放音频 | 播放 | 10 | 播放音频文件 |
| ExportAudio | 导出音频 | 导出 | 20 | 导出音频文件 |
| GenerateTargetAudioMenuAction | 生成目标音频 | 音频 | 30 | 生成完整的目标音频 |
| AdjustAudioSpeed | 调整音频速度 | 调整 | 40 | 调整音频片段速度 |

### 片段菜单已实现的菜单方法

#### SRTClip

| 方法名 | 显示文本 | 分组 | 排序 | 说明 |
|--------|----------|------|------|------|
| TranslateSubtitle | 翻译字幕 | 翻译 | 10 | 翻译字幕 |
| GenerateTTS | 生成TTS音频 | 音频 | 20 | 为字幕生成TTS音频 |
| CopyText | 复制文本 | 编辑 | 10 | 复制字幕文本到剪贴板 |
| EditText | 编辑文本 | 编辑 | 20 | 编辑字幕文本 |

#### AudioClip

| 方法名 | 显示文本 | 分组 | 排序 | 说明 |
|--------|----------|------|------|------|
| AdjustAudioSpeed | 调整音频速度 | 调整 | 10 | 调整音频片段速度 |
| AdjustAudioSpeedWithEndEmptyTime | 调整音频速度(使用末尾空白) | 调整 | 20 | 使用末尾空白时间调整音频速度 |
| RecomputeDuration | 重新计算时长 | 调整 | 30 | 重新计算音频时长 |
| ExportAudio | 导出音频 | 导出 | 10 | 导出音频文件 |
| OpenFileLocation | 打开文件所在位置 | 导出 | 20 | 在资源管理器中打开文件所在位置 |

## 片段菜单使用方法

### 片段菜单基本用法

在 Clip 的任何子类中，只需在方法上添加 `[ContextMenuAction]` 特性：

```csharp
public class SRTClip : Clip
{
    [ContextMenuAction("翻译字幕", Order = 10, Group = "翻译")]
    public async Task TranslateSubtitle()
    {
        // 实现翻译逻辑
    }
}
```

### 片段菜单初始化设置

在使用前，需要确保 `SimpleTrackControl.ViewModel` 属性已经被正确设置：

```csharp
// 在创建轨道控件时
var trackControl = new SimpleTrackControl
{
    TrackInfo = track,
    ViewModel = viewModel
};
```

片段控件会自动从轨道控件继承 ViewModel 属性。

## 最佳实践

### 1. 方法命名规范

- 菜单方法应该是公共方法（public）
- 方法名应该清晰表达其功能
- 建议使用异步方法（Task）以避免阻塞UI

### 2. 错误处理

```csharp
[ContextMenuAction("翻译字幕")]
public async Task TranslateSubtitle()
{
    try
    {
        // 实现逻辑
    }
    catch (Exception ex)
    {
        // 记录错误
        Log.Error(ex, "翻译字幕失败");
        throw;
    }
}
```

### 3. 进度反馈

```csharp
[ContextMenuAction("翻译字幕")]
public async Task TranslateSubtitle()
{
    IServices s = this;
    s.ProgressService?.ShowProgress();
    s.ProgressService?.SetStatusMessage("正在翻译...");
    
    try
    {
        // 实现逻辑
    }
    finally
    {
        s.ProgressService?.ResetProgress();
    }
}
```

### 4. 参数验证

```csharp
[ContextMenuAction("生成TTS音频")]
public async Task GenerateTTS()
{
    var subtitles = Segments.OfType<SRTClip>().ToList();
    
    if (subtitles.Count == 0)
    {
        throw new InvalidOperationException("没有可生成TTS的字幕片段");
    }
    
    // 实现逻辑
}
```

### 5. 使用 IsAutoCommit

对于需要修改数据库的操作，使用 `IsAutoCommit` 简化代码：

```csharp
[ContextMenuAction("删除轨道", IsAutoCommit = true)]
public void DeleteTrack()
{
    this.VideoProject.Tracks.Remove(this);
    // 自动提交，无需手动调用 CommitChanges()
}
```

### 6. 分组设计

建议的分组名称：
- "翻译" - 翻译相关操作
- "音频" - 音频处理相关操作
- "导出" - 导出相关操作
- "调整" - 调整相关操作
- "播放" - 播放相关操作
- "通用" - 通用操作

## 技术细节

### 反射实现

```csharp
var methods = trackType.GetMethods(
    BindingFlags.Public | 
    BindingFlags.Instance | 
    BindingFlags.FlattenHierarchy
);

var actionMethods = methods
    .Where(m => m.DeclaringType != typeof(object))
    .Select(m => new
    {
        Method = m,
        Attribute = m.GetCustomAttribute<ContextMenuActionAttribute>()
    })
    .Where(x => x.Attribute != null)
    .OrderBy(x => x.Attribute.Order)
    .ThenBy(x => x.Attribute.DisplayName)
    .ToList();
```

### 异步方法支持

```csharp
var result = method.Invoke(track, args);
if (result is Task task)
{
    await task;
}
```

### 自动提交实现

```csharp
if (attribute.IsAutoCommit && viewModel?.ObjectSpace != null)
{
    try
    {
        viewModel.ObjectSpace.CommitChanges();
    }
    catch (Exception ex)
    {
        _logger.Error(ex, "自动提交更改失败");
    }
}
```

## 扩展性

系统设计考虑了以下扩展性：

1. **自定义图标**：通过 `Icon` 属性支持自定义图标
2. **条件启用**：通过 `IsEnabled` 属性控制菜单项是否可用
3. **多级分组**：支持任意数量的分组
4. **参数扩展**：可以轻松添加对更多参数类型的支持

## 注意事项

1. **ObjectSpace 设置**：使用 `IObjectSpace` 参数或 `IsAutoCommit` 前，必须确保 `TimeLineViewModel.ObjectSpace` 已被正确设置
2. **线程安全**：菜单方法在UI线程执行，长时间操作应使用异步方法
3. **异常处理**：建议在方法中添加适当的异常处理
4. **性能考虑**：反射操作有一定开销，但仅在菜单创建时执行一次

## 示例项目

完整的使用示例可以在以下文件中找到：

- `d:\VideoTranslator\VT\VT.Module\BusinessObjects\Track\SRTTrackInfo.cs`
- `d:\VideoTranslator\VT\VT.Module\BusinessObjects\Track\AudioTrackInfo.cs`
- `d:\VideoTranslator\TimeLine\Controls\TrackContextMenuFactory.cs`

## 总结

轨道上下文菜单系统通过声明式编程简化了菜单开发，提高了代码的可维护性和可扩展性。开发者只需关注业务逻辑的实现，菜单的创建和调用由系统自动处理。
