<Window x:Class="VideoEditor.Windows.VideoDownloadWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:helpers="clr-namespace:VideoEditor.Helpers"
        Title="下载视频" Height="600" Width="900"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResizeWithGrip">
    <Window.Resources>
        <helpers:BoolToPremiumTextConverter x:Key="BoolToPremiumTextConverter"/>
        <helpers:DurationFormatterConverter x:Key="DurationFormatterConverter"/>
        <helpers:DurationFormatterShortConverter x:Key="DurationFormatterShortConverter"/>
    </Window.Resources>
    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="下载视频" FontSize="16" FontWeight="Bold" Margin="0,0,0,10"/>

        <TabControl Grid.Row="1" x:Name="MainTabControl">
            <TabItem Header="下载选项">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Grid Grid.Row="0" Margin="0,0,0,10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0" Text="视频地址:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                            <TextBox Grid.Column="1" x:Name="UrlTextBox" VerticalContentAlignment="Center" Height="25"/>
                            <Button Grid.Column="2" x:Name="FetchButton" Content="获取信息" Width="80" Height="25" Margin="10,0,0,0" Click="FetchButton_Click"/>
                        </Grid>

                        <TextBlock Grid.Row="1" x:Name="VideoInfoTextBlock" Text="" Foreground="Gray" Margin="0,0,0,10" TextWrapping="Wrap" Visibility="Collapsed"/>

                        <GroupBox Grid.Row="2" Header="视频格式" Margin="0,0,0,8" Visibility="Collapsed" x:Name="VideoGroupBox">
                            <Grid Margin="8">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <DataGrid Grid.Row="0" x:Name="VideoFormatsDataGrid" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False" SelectionMode="Extended" IsReadOnly="True" MaxHeight="200">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="格式ID" Binding="{Binding FormatId}" Width="70"/>
                                        <DataGridTextColumn Header="分辨率" Binding="{Binding Resolution}" Width="90"/>
                                        <DataGridTextColumn Header="宽" Binding="{Binding Width}" Width="50"/>
                                        <DataGridTextColumn Header="高" Binding="{Binding Height}" Width="50"/>
                                        <DataGridTextColumn Header="帧率" Binding="{Binding Fps}" Width="50"/>
                                        <DataGridTextColumn Header="视频编码" Binding="{Binding VCodec}" Width="90"/>
                                        <DataGridTextColumn Header="视频比特率" Binding="{Binding Vbr}" Width="80"/>
                                        <DataGridTextColumn Header="音频编码" Binding="{Binding ACodec}" Width="90"/>
                                        <DataGridTextColumn Header="音频比特率" Binding="{Binding Abr}" Width="80"/>
                                        <DataGridTextColumn Header="总比特率" Binding="{Binding Tbr}" Width="80"/>
                                        <DataGridTextColumn Header="动态范围" Binding="{Binding DynamicRange}" Width="70"/>
                                        <DataGridTextColumn Header="容器" Binding="{Binding Container}" Width="60"/>
                                        <DataGridTextColumn Header="协议" Binding="{Binding Protocol}" Width="70"/>
                                        <DataGridTextColumn Header="扩展名" Binding="{Binding Ext}" Width="60"/>
                                        <DataGridTextColumn Header="大小" Binding="{Binding FileSize}" Width="80"/>
                                        <DataGridTextColumn Header="DRM" Binding="{Binding HasDrm}" Width="50"/>
                                        <DataGridTextColumn Header="备注" Binding="{Binding FormatNote}" Width="*"/>
                                        <DataGridTextColumn Header="会员" Binding="{Binding RequiresPremium, Converter={StaticResource BoolToPremiumTextConverter}}" Width="60"/>
                                    </DataGrid.Columns>
                                </DataGrid>

                                <CheckBox Grid.Row="1" x:Name="DownloadVideoCheckBox" Content="下载视频" IsChecked="True" Margin="0,8,0,0" VerticalAlignment="Center"/>
                            </Grid>
                        </GroupBox>

                        <GroupBox Grid.Row="3" Header="音频格式" Margin="0,0,0,8" Visibility="Collapsed" x:Name="AudioGroupBox">
                            <Grid Margin="8">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <DataGrid Grid.Row="0" x:Name="AudioFormatsDataGrid" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False" SelectionMode="Extended" IsReadOnly="True" MaxHeight="200">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="格式ID" Binding="{Binding FormatId}" Width="70"/>
                                        <DataGridTextColumn Header="扩展名" Binding="{Binding Ext}" Width="60"/>
                                        <DataGridTextColumn Header="音频编码" Binding="{Binding ACodec}" Width="90"/>
                                        <DataGridTextColumn Header="音频比特率" Binding="{Binding Abr}" Width="80"/>
                                        <DataGridTextColumn Header="总比特率" Binding="{Binding Tbr}" Width="80"/>
                                        <DataGridTextColumn Header="采样率" Binding="{Binding AudioSamplingRate}" Width="70"/>
                                        <DataGridTextColumn Header="声道数" Binding="{Binding AudioChannels}" Width="60"/>
                                        <DataGridTextColumn Header="容器" Binding="{Binding Container}" Width="60"/>
                                        <DataGridTextColumn Header="协议" Binding="{Binding Protocol}" Width="70"/>
                                        <DataGridTextColumn Header="语言" Binding="{Binding Language}" Width="80"/>
                                        <DataGridTextColumn Header="大小" Binding="{Binding FileSize}" Width="80"/>
                                        <DataGridTextColumn Header="DRM" Binding="{Binding HasDrm}" Width="50"/>
                                        <DataGridTextColumn Header="备注" Binding="{Binding FormatNote}" Width="*"/>
                                    </DataGrid.Columns>
                                </DataGrid>

                                <CheckBox Grid.Row="1" x:Name="DownloadAudioCheckBox" Content="下载音频" IsChecked="True" Margin="0,8,0,0" VerticalAlignment="Center"/>
                            </Grid>
                        </GroupBox>

                        <GroupBox Grid.Row="4" Header="字幕" Margin="0,0,0,8" Visibility="Collapsed" x:Name="SubtitleGroupBox">
                            <Grid Margin="8">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <DataGrid Grid.Row="0" x:Name="SubtitlesDataGrid" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False" SelectionMode="Extended" IsReadOnly="True" MaxHeight="120">
                                    <DataGrid.Columns>
                                        <DataGridCheckBoxColumn Header="选择" Binding="{Binding IsSelected}" Width="50"/>
                                        <DataGridTextColumn Header="语言代码" Binding="{Binding LanguageCode}" Width="100"/>
                                        <DataGridTextColumn Header="语言名称" Binding="{Binding LanguageName}" Width="150"/>
                                        <DataGridTextColumn Header="类型" Binding="{Binding SubtitleType}" Width="80"/>
                                    </DataGrid.Columns>
                                </DataGrid>

                                <Grid Grid.Row="1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <CheckBox Grid.Column="0" x:Name="DownloadSubtitleCheckBox" Content="下载字幕" IsChecked="True" Margin="0,8,10,0" VerticalAlignment="Center"/>
                                    <Button Grid.Column="2" x:Name="SelectAllSubtitlesButton" Content="全选" Width="60" Height="25" Margin="0,8,5,0" VerticalAlignment="Center" Click="SelectAllSubtitlesButton_Click"/>
                                    <Button Grid.Column="3" x:Name="DeselectAllSubtitlesButton" Content="清空" Width="60" Height="25" Margin="0,8,0,0" VerticalAlignment="Center" Click="DeselectAllSubtitlesButton_Click"/>
                                </Grid>
                            </Grid>
                        </GroupBox>

                        <Button Grid.Row="5" x:Name="DownloadButton" Content="下载" Width="100" Height="28" HorizontalAlignment="Left" Margin="0,10,0,0" Click="DownloadButton_Click" IsEnabled="False"/>
                    </Grid>
                </ScrollViewer>
            </TabItem>

            <TabItem Header="VAD检测与分割">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <GroupBox Grid.Row="0" Header="VAD参数设置" Margin="0,0,0,8">
                            <Grid Margin="8">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <CheckBox Grid.Row="0" x:Name="EnableVadCheckBox" Content="启用VAD检测" IsChecked="False" Margin="0,0,0,8" VerticalAlignment="Center"/>

                                <Grid Grid.Row="1" Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="阈值:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <TextBox Grid.Column="1" x:Name="VadThresholdTextBox" Text="0.5" VerticalContentAlignment="Center" Height="25"/>
                                </Grid>

                                <Grid Grid.Row="2" Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="最小语音时长(ms):" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <TextBox Grid.Column="1" x:Name="MinSpeechDurationTextBox" Text="250" VerticalContentAlignment="Center" Height="25"/>
                                </Grid>

                                <Grid Grid.Row="3" Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="最小静音时长(ms):" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <TextBox Grid.Column="1" x:Name="MinSilenceDurationTextBox" Text="100" VerticalContentAlignment="Center" Height="25"/>
                                </Grid>
                            </Grid>
                        </GroupBox>

                        <GroupBox Grid.Row="1" Header="VAD检测结果" Margin="0,0,0,8" Visibility="Collapsed" x:Name="VadResultGroupBox">
                            <Grid Margin="8">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <Grid Grid.Row="0" Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="音频时长:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                    <TextBlock Grid.Column="1" x:Name="VadDurationText" Text="" VerticalAlignment="Center" Margin="0,0,15,0" FontWeight="Bold"/>

                                    <TextBlock Grid.Column="2" Text="语音段:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                    <TextBlock Grid.Column="3" x:Name="VadSpeechCountText" Text="" VerticalAlignment="Center" Margin="0,0,15,0" FontWeight="Bold"/>

                                    <TextBlock Grid.Column="4" Text="静音段:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                    <TextBlock Grid.Column="5" x:Name="VadSilenceCountText" Text="" VerticalAlignment="Center" FontWeight="Bold"/>
                                </Grid>

                                <Grid Grid.Row="1" Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="总语音时长:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                    <TextBlock Grid.Column="1" x:Name="VadTotalSpeechText" Text="" VerticalAlignment="Center" Margin="0,0,15,0" FontWeight="Bold"/>

                                    <TextBlock Grid.Column="2" Text="总静音时长:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                    <TextBlock Grid.Column="3" x:Name="VadTotalSilenceText" Text="" VerticalAlignment="Center" FontWeight="Bold"/>
                                </Grid>

                                <TextBlock Grid.Row="2" Text="VAD分段详情:" FontWeight="Bold" Margin="0,0,0,5"/>

                                <DataGrid Grid.Row="3" x:Name="VadSegmentsDataGrid" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False" SelectionMode="Extended" IsReadOnly="True" MaxHeight="150">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="序号" Binding="{Binding Index}" Width="50"/>
                                        <DataGridTextColumn Header="类型" Binding="{Binding Type}" Width="60"/>
                                        <DataGridTextColumn Header="开始时间" Binding="{Binding Start, Converter={StaticResource DurationFormatterShortConverter}}" Width="90"/>
                                        <DataGridTextColumn Header="结束时间" Binding="{Binding End, Converter={StaticResource DurationFormatterShortConverter}}" Width="90"/>
                                        <DataGridTextColumn Header="时长" Binding="{Binding Duration, Converter={StaticResource DurationFormatterConverter}}" Width="90"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </Grid>
                        </GroupBox>

                        <GroupBox Grid.Row="2" Header="分割方案" Margin="0,0,0,8" Visibility="Collapsed" x:Name="SplitSuggestionGroupBox">
                            <Grid Margin="8">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <TextBlock Grid.Row="0" Text="选择分割方案（静音时长越长越合适）:" FontWeight="Bold" Margin="0,0,0,5"/>

                                <DataGrid Grid.Row="1" x:Name="SplitSuggestionDataGrid" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False" SelectionMode="Single" IsReadOnly="True" MaxHeight="120" SelectionChanged="SplitSuggestionDataGrid_SelectionChanged">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="方案" Binding="{Binding Index}" Width="60"/>
                                        <DataGridTextColumn Header="分段数" Binding="{Binding SegmentCount}" Width="80"/>
                                        <DataGridTextColumn Header="平均时长" Binding="{Binding AverageDuration, Converter={StaticResource DurationFormatterConverter}}" Width="100"/>
                                        <DataGridTextColumn Header="最小静音时长" Binding="{Binding MinSilenceDuration, Converter={StaticResource DurationFormatterShortConverter}}" Width="120"/>
                                        <DataGridTextColumn Header="说明" Binding="{Binding Description}" Width="*"/>
                                    </DataGrid.Columns>
                                </DataGrid>

                                <TextBlock Grid.Row="2" Text="方案详情:" FontWeight="Bold" Margin="0,10,0,5"/>

                                <DataGrid Grid.Row="3" x:Name="SchemeSegmentsDataGrid" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False" SelectionMode="Single" IsReadOnly="True" MaxHeight="150">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="段号" Binding="{Binding SegmentIndex}" Width="50"/>
                                        <DataGridTextColumn Header="开始时间" Binding="{Binding StartTime, Converter={StaticResource DurationFormatterShortConverter}}" Width="90"/>
                                        <DataGridTextColumn Header="结束时间" Binding="{Binding EndTime, Converter={StaticResource DurationFormatterShortConverter}}" Width="90"/>
                                        <DataGridTextColumn Header="时长" Binding="{Binding Duration, Converter={StaticResource DurationFormatterConverter}}" Width="90"/>
                                        <DataGridTextColumn Header="静音开始" Binding="{Binding SplitSilenceStart, Converter={StaticResource DurationFormatterShortConverter}}" Width="90"/>
                                        <DataGridTextColumn Header="静音结束" Binding="{Binding SplitSilenceEnd, Converter={StaticResource DurationFormatterShortConverter}}" Width="90"/>
                                        <DataGridTextColumn Header="静音时长" Binding="{Binding SplitSilenceDuration, Converter={StaticResource DurationFormatterShortConverter}}" Width="90"/>
                                    </DataGrid.Columns>
                                </DataGrid>

                                <Button Grid.Row="4" x:Name="ExecuteSplitButton" Content="执行分割" Width="100" Height="28" HorizontalAlignment="Left" Margin="0,10,0,0" Click="ExecuteSplitButton_Click" IsEnabled="False"/>
                            </Grid>
                        </GroupBox>
                    </Grid>
                </ScrollViewer>
            </TabItem>
        </TabControl>

        <Grid Grid.Row="2" x:Name="LoadingPanel" Visibility="Collapsed">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Margin="0,20,0,20">
                <TextBlock x:Name="LoadingTextBlock" Text="正在获取视频信息..." HorizontalAlignment="Center" Margin="0,0,0,10"/>
                <ProgressBar Width="200" Height="20" IsIndeterminate="True"/>
            </StackPanel>
        </Grid>

        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,15,0,0">
            <Button x:Name="NewProjectButton" Content="新建项目" Width="80" Height="28" Margin="0,0,10,0" Click="NewProjectButton_Click" IsEnabled="False"/>
            <Button x:Name="OkButton" Content="确定" Width="80" Height="28" Margin="0,0,10,0" Click="OkButton_Click" IsEnabled="True"/>
            <Button x:Name="CancelButton" Content="取消" Width="80" Height="28" Click="CancelButton_Click" IsCancel="True"/>
        </StackPanel>
    </Grid>
</Window>
