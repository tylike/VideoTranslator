# WPF WaveformControl 架构设计文档

## 1. 概述

### 1.1 设计目标

- **高性能**：支持10行 × 2000个元素（20,000个元素）流畅显示
- **低耦合**：WPF控件与WinForm应用解耦
- **易扩展**：支持新增轨道类型和元素类型
- **易维护**：清晰的职责划分和模块化设计
- **高性能渲染**：使用Canvas + 自定义绘制，无句柄限制

### 1.2 技术选型

| 层级 | 技术 | 理由 |
|------|------|------|
| UI层 | WPF | 高性能图形渲染，无句柄限制 |
| 集成层 | ElementHost | WinForm与WPF互操作 |
| 数据层 | 共享模型 | WinForm和WPF共享数据模型 |
| 渲染层 | Canvas + 自定义绘制 | 完全控制渲染，性能最优 |

---

## 2. 整体架构

### 2.1 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    WinForm 应用层                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  工具栏      │  │  状态栏      │  │  其他控件    │     │
│  │  (WinForm)  │  │  (WinForm)  │  │  (WinForm)  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              ElementHost (集成层)                     │   │
│  │  ┌───────────────────────────────────────────────┐  │   │
│  │  │         WPF WaveformControl (WPF层)           │  │   │
│  │  │                                               │  │   │
│  │  │  ┌─────────────────────────────────────────┐ │  │   │
│  │  │  │  WaveformCanvas (渲染层)                │ │  │   │
│  │  │  │  - 自定义绘制                           │ │  │   │
│  │  │  │  - 命中测试                             │ │  │   │
│  │  │  │  - 事件处理                             │ │  │   │
│  │  │  └─────────────────────────────────────────┘ │  │   │
│  │  │                                               │  │   │
│  │  │  ┌─────────────────────────────────────────┐ │  │   │
│  │  │  │  WaveformRenderer (渲染引擎)            │ │  │   │
│  │  │  │  - 波形绘制                             │ │  │   │
│  │  │  │  - 时间标记                             │ │  │   │
│  │  │  │  - 轨道标签                             │ │  │   │
│  │  │  └─────────────────────────────────────────┘ │  │   │
│  │  │                                               │  │   │
│  │  │  ┌─────────────────────────────────────────┐ │  │   │
│  │  │  │  ElementManager (元素管理)               │ │  │   │
│  │  │  │  - 元素创建                             │ │  │   │
│  │  │  │  - 空间索引                             │ │  │   │
│  │  │  │  - 可见性管理                           │ │  │   │
│  │  │  └─────────────────────────────────────────┘ │  │   │
│  │  │                                               │  │   │
│  │  │  ┌─────────────────────────────────────────┐ │  │   │
│  │  │  │  InteractionManager (交互管理)           │ │  │   │
│  │  │  │  - 鼠标事件                             │ │  │   │
│  │  │  │  - 键盘事件                             │ │  │   │
│  │  │  │  - 拖拽支持                             │ │  │   │
│  │  │  └─────────────────────────────────────────┘ │  │   │
│  │  │                                               │  │   │
│  │  │  ┌─────────────────────────────────────────┐ │  │   │
│  │  │  │  StyleManager (样式管理)                │ │  │   │
│  │  │  │  - 样式配置                             │ │  │   │
│  │  │  │  - 主题切换                             │ │  │   │
│  │  │  └─────────────────────────────────────────┘ │  │   │
│  │  │                                               │  │   │
│  │  └───────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    共享数据层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ WaveformData │  │  样式配置    │  │  事件接口    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模块职责

| 模块 | 职责 | 依赖 |
|------|------|------|
| WinForm应用层 | 工具栏、状态栏、其他WinForm控件 | WPF WaveformControl |
| ElementHost | WinForm与WPF互操作 | WPF WaveformControl |
| WaveformControl | WPF波形控件主类 | WaveformCanvas, WaveformRenderer |
| WaveformCanvas | 渲染层，自定义绘制 | ElementManager, InteractionManager |
| WaveformRenderer | 渲染引擎，绘制波形和时间标记 | 样式配置 |
| ElementManager | 元素管理，空间索引 | 数据模型 |
| InteractionManager | 交互管理，事件处理 | ElementManager |
| StyleManager | 样式管理，主题切换 | 样式配置 |
| 共享数据层 | 数据模型和接口 | 无 |

---

## 3. 控件拆分设计

### 3.1 控件层次结构

```
WaveformControl (主控件)
├── WaveformCanvas (渲染画布)
│   ├── WaveformRenderer (渲染引擎)
│   ├── ElementManager (元素管理)
│   └── InteractionManager (交互管理)
└── StyleManager (样式管理)
```

### 3.2 WaveformControl (主控件)

**职责**：
- 控件的入口点
- 协调各子模块
- 提供公共API
- 处理与WinForm的交互

**公共属性**：
- Data：波形数据模型
- Style：样式配置
- ZoomLevel：缩放级别
- ScrollOffset：滚动偏移量
- SelectedElement：当前选中的元素

**公共方法**：
- Refresh：刷新控件显示
- ScrollTo：滚动到指定位置
- ZoomTo：缩放到指定级别
- SelectElement：选中指定元素
- GetElementBounds：获取元素边界

**公共事件**：
- ElementClicked：元素被点击
- ElementDoubleClicked：元素被双击
- ElementHovered：元素被悬停
- SelectionChanged：选中状态改变
- ScrollChanged：滚动位置改变
- ZoomChanged：缩放级别改变

**依赖注入**：
- 创建并初始化所有子模块
- 注入各模块之间的依赖关系
- 将WaveformCanvas添加到可视化树

---

### 3.3 WaveformCanvas (渲染画布)

**职责**：
- 自定义绘制
- 命中测试
- 可见性管理
- 性能优化

**渲染流程**：
1. 绘制背景
2. 绘制轨道背景
3. 绘制波形
4. 绘制可见元素（只绘制可见区域）
5. 绘制时间标记
6. 绘制轨道标签
7. 绘制选择框

**命中测试**：
- 处理鼠标移动事件，检测悬停元素
- 处理鼠标按下事件，检测点击元素
- 委托给ElementManager进行实际的命中测试

**性能优化**：
- 使用BitmapCache进行缓存
- 只重绘脏区域
- 只绘制可见区域内的元素

---

### 3.4 WaveformRenderer (渲染引擎)

**职责**：
- 绘制波形
- 绘制时间标记
- 绘制轨道标签
- 缓存管理

**波形绘制功能**：
- 根据采样数据绘制音频波形
- 支持自定义波形线条样式
- 支持自定义波形颜色和粗细

**时间标记绘制功能**：
- 根据总时长自动计算时间间隔
- 绘制时间刻度线
- 绘制时间文本标签
- 支持自定义时间格式

**轨道标签绘制功能**：
- 绘制各轨道的标签文本
- 支持自定义标签位置和样式
- 支持自定义标签颜色和字体

**缓存管理功能**：
- 管理波形缓存
- 在数据变化时更新缓存
- 提高渲染性能

---

### 3.5 ElementManager (元素管理)

**职责**：
- 元素创建和管理
- 空间索引（四叉树）
- 可见性管理
- 命中测试

**元素创建功能**：
- 根据数据创建VAD元素
- 根据数据创建Clip元素
- 支持创建容器元素和子元素
- 自动计算元素边界

**空间索引功能**：
- 使用四叉树进行空间索引
- 快速查询指定区域内的元素
- 提高命中测试性能
- 支持动态更新索引

**可见性管理功能**：
- 只返回可见区域内的元素
- 支持元素显示/隐藏
- 提高渲染性能

**命中测试功能**：
- 根据坐标点查找元素
- 支持从上到下的层级查找
- 考虑元素的可见性

**元素查询功能**：
- 根据ID查找元素
- 获取所有元素列表
- 清空所有元素

---

### 3.6 InteractionManager (交互管理)

**职责**：
- 鼠标事件处理
- 键盘事件处理
- 拖拽支持
- 选择管理

**鼠标事件处理功能**：
- 处理鼠标移动事件
- 处理鼠标按下事件
- 处理鼠标释放事件
- 处理鼠标悬停状态

**键盘事件处理功能**：
- 处理键盘按下事件
- 支持快捷键操作
- 支持元素导航

**拖拽支持功能**：
- 支持元素拖拽移动
- 计算拖拽偏移量
- 更新元素位置

**选择管理功能**：
- 管理当前选中的元素
- 支持单选和多选
- 触发选择改变事件

**事件触发功能**：
- 触发元素点击事件
- 触发元素双击事件
- 触发元素悬停事件
- 触发选择改变事件

---

### 3.7 StyleManager (样式管理)

**职责**：
- 样式配置
- 主题切换
- 样式应用

**样式配置功能**：
- 管理波形样式（颜色、粗细等）
- 管理时间标记样式
- 管理轨道标签样式
- 管理VAD元素样式
- 管理Clip元素样式

**主题切换功能**：
- 支持浅色主题
- 支持深色主题
- 支持自定义主题
- 主题切换时自动刷新控件

**样式应用功能**：
- 应用样式到控件
- 应用样式到各个元素
- 支持样式继承
- 支持样式覆盖

---

## 4. 数据模型设计

### 4.1 WaveformData (波形数据)

**功能**：
- 存储音频采样数据
- 存储VAD分段数据
- 存储Clip数据
- 存储总时长信息

**主要属性**：
- Samples：音频采样数组
- VadSegments：VAD分段列表
- Clips：Clip列表
- Duration：总时长

---

### 4.2 WaveformStyle (样式配置)

**功能**：
- 配置波形显示样式
- 配置时间标记样式
- 配置轨道标签样式
- 配置各种元素样式

**主要属性**：
- WaveformLineStyle：波形线条样式
- TimeMarkerStyle：时间标记样式
- LabelStyle：标签样式
- VadSegmentStyle：VAD分段样式
- ClipStyle：Clip样式

---

### 4.3 WaveformElement (波形元素基类)

**功能**：
- 定义元素的通用属性和行为
- 支持元素渲染
- 支持元素命中测试
- 支持元素交互

**主要属性**：
- Id：元素唯一标识
- Bounds：元素边界
- IsVisible：是否可见
- IsHovered：是否被悬停
- IsSelected：是否被选中

**主要方法**：
- Render：渲染元素
- HitTest：命中测试
- Move：移动元素

---

## 5. 性能优化策略

### 5.1 渲染优化

**可见性剔除**：
- 只渲染可见区域内的元素
- 使用空间索引快速查询可见元素
- 减少不必要的绘制操作

**缓存机制**：
- 使用BitmapCache缓存静态内容
- 缓存波形数据
- 缓存时间标记

**脏区域重绘**：
- 只重绘发生变化的区域
- 避免全屏重绘
- 提高渲染效率

---

### 5.2 空间索引优化

**四叉树索引**：
- 使用四叉树进行空间索引
- 快速查询指定区域内的元素
- 提高命中测试性能
- 支持动态更新

**分层索引**：
- 支持多级空间索引
- 根据元素大小选择合适的索引层级
- 提高查询效率

---

### 5.3 事件处理优化

**事件节流**：
- 对频繁触发的事件进行节流
- 减少不必要的处理
- 提高响应性能

**事件委托**：
- 将事件处理委托给专门的模块
- 减少主控件的负担
- 提高代码可维护性

---

## 6. 扩展性设计

### 6.1 元素类型扩展

**新增元素类型**：
- 继承WaveformElement基类
- 实现Render方法
- 实现HitTest方法
- 在ElementManager中注册新元素类型

**自定义元素渲染**：
- 支持自定义绘制逻辑
- 支持自定义样式
- 支持自定义交互行为

---

### 6.2 轨道类型扩展

**新增轨道类型**：
- 定义新的轨道配置
- 在StyleManager中注册新轨道
- 在WaveformRenderer中添加绘制逻辑

**自定义轨道样式**：
- 支持自定义轨道背景
- 支持自定义轨道标签
- 支持自定义轨道高度

---

### 6.3 主题扩展

**新增主题**：
- 定义新的主题配置
- 在StyleManager中注册新主题
- 支持主题切换

**自定义主题样式**：
- 支持自定义颜色方案
- 支持自定义字体方案
- 支持自定义布局方案

---

## 7. 交互设计

### 7.1 鼠标交互

**点击交互**：
- 单击选中元素
- 双击打开元素详情
- 支持多选

**拖拽交互**：
- 拖拽移动元素
- 拖拽调整元素大小
- 拖拽创建新元素

**悬停交互**：
- 悬停显示元素提示
- 悬停高亮元素
- 悬停显示元素详情

---

### 7.2 键盘交互

**快捷键支持**：
- 支持删除元素
- 支持复制粘贴
- 支持撤销重做
- 支持元素导航

---

### 7.3 滚动交互

**滚动支持**：
- 支持鼠标滚轮滚动
- 支持拖拽滚动条
- 支持程序控制滚动

**缩放支持**：
- 支持鼠标滚轮缩放
- 支持拖拽缩放
- 支持程序控制缩放

---

## 8. 版本历史

| 版本 | 日期 | 作者 | 说明 |
|------|------|------|------|
| 1.0 | 2026-01-21 | - | 初始版本 |
