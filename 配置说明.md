# 配置文件说明

## 概述

项目现在使用统一的 JSON 配置文件 `config.json` 进行配置管理。所有配置项都从此文件读取，不再使用 App.config。

## 配置文件位置

- **主配置文件**: `d:\VideoTranslator\config.json`
- **示例文件**: `d:\VideoTranslator\config.example.json`

## 配置文件不存在时的行为

如果 `config.json` 文件不存在，程序启动时会抛出异常并显示配置文件路径。请确保配置文件存在。

## 配置结构

```json
{
  "VideoTranslator": {
    "Paths": {
      "FfmpegPath": "D:\\VideoTranslator\\ffmpeg\\ffmpeg.exe",
      "YtDlpPath": "yt-dlp",
      "WhisperPath": "C:\\Users\\Administrator\\AppData\\Roaming\\Subtitle Edit\\Whisper\\Cpp\\whisper-cli.exe",
      "WhisperModelPath": "D:\\VideoTranslator\\whisper.cpp\\ggml-large-v3.bin",
      "BaseDirectory": "videoProjects",
      "PythonPath": "python",
      "AudioSeparationScriptPath": "d:\\VideoTranslator\\VT\\VT.Module\\PythonScripts\\demucs_run.py",
      "DemucsOutputBasePath": "d:\\VideoTranslator\\videoProjects",
      "VoskModelPath": "C:\\Users\\Administrator\\AppData\\Roaming\\Subtitle Edit\\Vosk\\vosk-model-en-us-0.22",
      "VoskSpeakerModelPath": "D:\\VideoTranslator\\第三方项目\\stt\\vosk-speaker-model\\vosk-model-spk-0.4",
      "PurfviewFasterWhisperPath": "C:\\Users\\Administrator\\AppData\\Roaming\\Subtitle Edit\\Whisper\\Purfview-Whisper-Faster\\faster-whisper-xxl.exe",
      "PurfviewFasterWhisperModelPath": "large-v3",
      "SherpaSegmentationModelPath": "d:\\VideoTranslator\\第三方项目\\stt\\sherpa-onnx-exe-v1.12.23\\sherpa-onnx-pyannote-segmentation-3-0\\model.onnx",
      "SherpaEmbeddingModelPath": "d:\\VideoTranslator\\第三方项目\\stt\\sherpa-onnx.models\\3dspeaker_speech_eres2net_base_sv_zh-cn_3dspeaker_16k.onnx",
      "SherpaEmbeddingModelPathEn": "d:\\VideoTranslator\\第三方项目\\stt\\sherpa-onnx.models\\wespeaker_en_voxceleb_resnet34_LM.onnx"
    },
    "LLM": {
      "ApiUrl": "http://127.0.0.1:1235/v1/chat/completions",
      "ApiKey": "dummy-key",
      "ModelName": "glm4.7-flash"
    },
    "TTS": {
      "Servers": [
        "http://192.168.1.154:8000/generate",
        "http://192.168.1.154:8001/generate",
        "http://192.168.1.154:8002/generate",
        "http://192.168.1.154:8003/generate",
        "http://192.168.1.154:8004/generate"
      ]
    },
    "General": {
      "KeepFiles": true
    }
  },
  "Database": {
    "ConnectionString": "Data Source=(localdb)\\mssqllocaldb;Integrated Security=SSPI;Pooling=false;Initial Catalog=VT02;TrustServerCertificate=True"
  }
}
```

## 配置项说明

### VideoTranslator.Paths

| 配置项 | 说明 | 默认值 |
|---------|------|---------|
| FfmpegPath | FFmpeg 可执行文件路径 | ffmpeg |
| YtDlpPath | yt-dlp 可执行文件路径 | yt-dlp |
| WhisperPath | Whisper 可执行文件路径 | whisper-cli.exe |
| WhisperModelPath | Whisper 模型文件路径 | ggml-tiny.en.bin |
| BaseDirectory | 项目基础目录 | d:\index-tts\Audio.En2Cn\projects |
| PythonPath | Python 可执行文件路径 | python |
| AudioSeparationScriptPath | 音频分离脚本路径 | demucs_run.py |
| DemucsOutputBasePath | Demucs 输出基础路径 | d:\VideoTranslator\videoProjects |
| VoskModelPath | Vosk 模型路径 | vosk-model-en-us-0.22 |
| VoskSpeakerModelPath | Vosk 说话人模型路径 | vosk-model-spk-0.4 |
| PurfviewFasterWhisperPath | Purfview Faster Whisper 路径 | faster-whisper-xxl.exe |
| PurfviewFasterWhisperModelPath | Purfview Faster Whisper 模型 | large-v3 |
| SherpaSegmentationModelPath | Sherpa 分段模型路径 | model.onnx |
| SherpaEmbeddingModelPath | Sherpa 嵌入模型路径（中文） | 3dspeaker_...onnx |
| SherpaEmbeddingModelPathEn | Sherpa 嵌入模型路径（英文） | wespeaker_en_voxceleb_resnet34_LM.onnx |
| NodePath | Node.js 可执行文件路径（用于 yt-dlp 提取 YouTube 视频） | C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Microsoft\VisualStudio\NodeJs\node.exe |

### VideoTranslator.LLM

| 配置项 | 说明 | 默认值 |
|---------|------|---------|
| ApiUrl | LLM API 地址 | http://127.0.0.1:1235/v1/chat/completions |
| ApiKey | LLM API 密钥 | dummy-key |
| ModelName | LLM 模型名称 | glm4.7-flash |

### VideoTranslator.TTS

| 配置项 | 说明 | 默认值 |
|---------|------|---------|
| Servers | TTS 服务器列表 | [] |

### VideoTranslator.General

| 配置项 | 说明 | 默认值 |
|---------|------|---------|
| KeepFiles | 是否保留中间文件 | true |

### Database

| 配置项 | 说明 | 默认值 |
|---------|------|---------|
| ConnectionString | 数据库连接字符串 | 空 |

## 代码中使用配置

### 读取配置

```csharp
using VideoTranslator.Config;

// 获取完整配置
var config = ConfigurationService.Configuration;

// 获取特定配置项
var ffmpegPath = config.VideoTranslator.Paths.FfmpegPath;
var apiUrl = config.VideoTranslator.LLM.ApiUrl;
var modelName = config.VideoTranslator.LLM.ModelName;
var connectionString = config.Database.ConnectionString;
```

### 使用 AppSettings（兼容旧代码）

```csharp
using VideoTranslator.Config;

// AppSettings 构造函数会自动从 config.json 加载配置
var settings = new AppSettings();

// 访问配置项
var ffmpegPath = settings.FfmpegPath;
var apiUrl = settings.LMStudioApiUrl;
var modelName = settings.LMStudioModelName;
```

### 保存配置

```csharp
// 修改配置
ConfigurationService.Configuration.VideoTranslator.LLM.ModelName = "new-model-name";

// 保存到文件
ConfigurationService.SaveConfiguration();
```

### 重新加载配置

```csharp
// 重新加载配置文件
ConfigurationService.ReloadConfiguration();
```

## 配置文件路径

获取配置文件路径：

```csharp
var configPath = ConfigurationService.GetConfigFilePath();
```

## 已迁移的项目

以下项目已迁移到使用 `config.json`：

- ✅ VideoEditor
- ✅ Logic
- ✅ VT.Console
- ✅ VT.Win
- ✅ TimeLine copy

## 注意事项

1. **配置文件必须存在** - 程序启动时会检查 `config.json` 是否存在，不存在则抛出异常
2. **JSON 格式必须正确** - 格式错误会导致程序无法启动
3. **路径分隔符** - Windows 路径使用双反斜杠 `\\` 或正斜杠 `/`
4. **相对路径** - 可以使用相对路径，相对于程序运行目录
5. **线程安全** - 配置读取和写入都是线程安全的

## 从 App.config 迁移

如果之前使用 App.config，请参考以下步骤迁移：

1. 打开 App.config 文件
2. 将所有 `<add key="...">` 配置项复制到 config.json 对应位置
3. 删除或重命名 App.config（建议重命名为 App.config.bak）
4. 确保程序运行目录下有 config.json 文件
