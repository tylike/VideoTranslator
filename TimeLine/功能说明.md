# TimeLine 项目功能说明

## 项目概述
这是一个基于 WPF 的时间线编辑控件库，用于显示和编辑视频项目的各种时间轴数据。该控件支持在 WinForms 和 WPF 中使用，采用 MVVM 模式设计。

## 核心功能

### 1. 多轨道时间轴显示
支持 9 种不同的时间轴行：

1. **时间轴**：显示时间刻度 <span style="color:#808080">■</span> #808080 (灰色)
2. **VAD**：语音活动检测片段 <span style="color:#FF6B6B">■</span> #FF6B6B (珊瑚红)
3. **源 SRT**：原始字幕 <span style="color:#4ECDC4">■</span> #4ECDC4 (青绿色)
4. **目标翻译 SRT**：翻译后的字幕 <span style="color:#45B7D1">■</span> #45B7D1 (天蓝色)
5. **源音频片段**：原始音频片段 <span style="color:#96CEB4">■</span> #96CEB4 (薄荷绿)
6. **目标翻译音频片段**：翻译后的音频片段 <span style="color:#FFD93D">■</span> #FFD93D (金黄色)
7. **调整音频片段**：调整后的音频片段 <span style="color:#FF8C42">■</span> #FF8C42 (橙红色)
8. **源人声音频**：完整的人声音频 <span style="color:#9B59B6">■</span> #9B59B6 (紫罗兰色)
9. **源背景音频**：完整的背景音频 <span style="color:#3498DB">■</span> #3498DB (蔚蓝色)

### 2. 交互功能
- **缩放功能**：支持 0.5x - 3.0x 缩放，可调整时间轴显示密度
- **音频播放**：点击音频片段可播放对应的音频文件
- **滚动支持**：支持水平和垂直滚动，方便查看长内容
- **防抖机制**：缩放操作使用 150ms 防抖，行更新使用 50ms 防抖，优化性能

### 3. 数据可视化
- **波形显示**：音频片段以波形形式显示，使用 NAudio 读取音频文件
- **颜色编码**：每种轨道类型使用不同的颜色进行区分，便于快速识别
  - 时间轴：灰色 (#808080)
  - VAD：珊瑚红 (#FF6B6B)
  - 源SRT：青绿色 (#4ECDC4)
  - 目标翻译SRT：天蓝色 (#45B7D1)
  - 源音频片段：薄荷绿 (#96CEB4)
  - 目标翻译音频片段：金黄色 (#FFD93D)
  - 调整音频片段：橙红色 (#FF8C42)
  - 源人声音频：紫罗兰色 (#9B59B6)
  - 源背景音频：蔚蓝色 (#3498DB)
- **时间刻度**：时间轴行显示时间刻度标记
- **片段定位**：根据时间戳自动计算片段的位置和宽度

## 技术架构

### 控件结构
```
SimpleTimeLinePanel (主控件)
├── LeftPanel (左侧标题区域)
│   └── TimeLineRow (行标题)
└── RightPanel (右侧时间轴区域)
    └── TimeLineRowControl (行内容)
        └── WaveformControl (波形/片段控件)
```

### 数据模型

#### TimeLineData
时间轴数据容器，包含：
- `TotalDuration`: 总时长（秒）
- `ZoomFactor`: 缩放因子（默认 1.0）
- `ScaledTotalDuration`: 缩放后的总时长（像素）
- `LeftPanelWidth`: 左侧面板宽度（默认 150）
- `Rows`: 时间轴行集合
- `DataLoaded`: 数据加载完成事件

#### TimeLineRow
单行数据，包含：
- `Index`: 行索引
- `Title`: 行标题
- `Height`: 行高度（默认 50）
- `Color`: 行颜色（十六进制颜色字符串，如 #808080）
- `Items`: 片段集合

#### TimeLineItem
单个片段，包含：
- `Start`: 开始时间（秒）
- `Duration`: 持续时间（秒）
- `Text`: 文本内容
- `FilePath`: 文件路径（音频文件）

### 转换器

#### StartToPixelConverter
将开始时间转换为像素位置：
- 输入：开始时间（秒）、缩放因子
- 输出：像素位置
- 公式：`Start * 10.0 * ZoomFactor`

#### DurationToPixelConverter
将持续时间转换为像素宽度：
- 输入：持续时间（秒）、缩放因子
- 输出：像素宽度
- 公式：`Duration * 10.0 * ZoomFactor`

#### TotalDurationToPixelConverter
将总持续时间转换为像素宽度：
- 输入：总持续时间（秒）、缩放因子
- 输出：像素宽度
- 公式：`TotalDuration * 10.0 * ZoomFactor`

#### StringToBrushConverter
将颜色字符串转换为 SolidColorBrush：
- 输入：颜色字符串（如 "#FF6B6B"）
- 输出：SolidColorBrush
- 用于 XAML 绑定中将字符串颜色转换为画刷

### 服务接口

#### IAudioPlayerService
音频播放服务接口，包含：
- `PlayAudioAsync(string filePath)`: 播放音频
- `StopAudio()`: 停止播放
- `IsPlaying`: 是否正在播放

#### IWaveformService
波形数据服务接口，包含：
- `LoadWaveformDataAsync(string filePath, int sampleCount)`: 加载波形数据
- 返回：归一化的波形数据列表（0.0 - 1.0）

### 实现细节

#### 手动控件创建
为了避免数据绑定导致的死循环问题，采用手动创建控件的方式：
- `SimpleTimeLinePanel.UpdateRows()`: 更新所有行
- `TimeLineRowControl.UpdateItems()`: 更新行中的片段
- 使用防抖机制优化性能

#### 波形显示
- 使用 NAudio 读取音频文件
- 根据音频时长动态计算采样点数（每秒 20 个采样点，范围 50-1000）
- 使用 Path 绘制波形，支持缩放和自适应
- 波形颜色：绿色 (#00FF00)，线条粗细：2 像素，高度：30 像素

#### 事件处理
- `DataLoaded` 事件：数据加载完成后触发，用于初始化 UI
- `CollectionChanged` 事件：避免使用，改用手动更新
- `PropertyChanged` 事件：用于响应缩放因子变化

## 使用方式

### 在 WinForms 中使用
```csharp
// 方式 1：直接传入 VideoProject
var host = this.CreateTimeLineHost(videoProject);

// 方式 2：传入 TimeLineViewModel
var host = this.CreateTimeLineHost(viewModel);

// 方式 3：自定义音频播放服务
var host = this.CreateTimeLineHost(viewModel, customAudioPlayerService);
```

### 在 WPF 中使用
```csharp
// 方式 1：使用 TimeLineWindow 窗口
var window = new TimeLineWindow();
window.DataContext = viewModel;
window.Show();

// 方式 2：直接使用 SimpleTimeLinePanel 控件
var panel = new SimpleTimeLinePanel();
panel.Data = viewModel.Data;
panel.AudioPlayerService = audioPlayerService;
panel.WaveformService = waveformService;
```

## 扩展性

### 自定义音频播放服务
通过实现 `IAudioPlayerService` 接口，可以自定义音频播放逻辑。

### 自定义波形服务
通过实现 `IWaveformService` 接口，可以自定义波形数据加载逻辑。

### 自定义样式
通过修改 `Themes/Generic.xaml` 可以自定义控件的外观样式。

## 技术栈
- .NET 9.0
- WPF
- MVVM 模式
- NAudio（音频处理）
- 依赖项：VT.Module (BusinessObjects)、WindowsFormsIntegration

## 适用场景
- 视频编辑软件
- 音频编辑工具
- 字幕编辑器
- 语音识别结果可视化
- 任何需要时间轴编辑功能的应用

## 特点
- **模块化设计**：各组件职责清晰，易于维护和扩展
- **数据驱动**：通过数据绑定和事件机制自动更新 UI
- **跨平台集成**：支持在 WinForms 和 WPF 中使用
- **性能优化**：使用防抖机制避免频繁 UI 更新
- **手动控件创建**：避免数据绑定导致的死循环问题

## 数据源说明

### 数据结构定义
数据结构定义在 `D:\VideoTranslator\VT\VT.Module\BusinessObjects` 中：

```csharp
var clips = videoProject.Clips; // 数据结构 TimelineClip
var srtClips = clips[0].SourceSRTClip; // 数据结构 SRTClip
// 这里的 [0] 是指第一个时间轴
var targetAudioClips = clips[0].TargetAudioClip; // 数据结构 TargetAudioClip
// 其他的片段级别的，都是这样存储的

// clips 中的数据是以 source SRT 来拆分的
// 即其他片段级别的数据，都是以 source SRT 为标准来存储的

var 人声音频 = videoProject.MediaSource.First(x => x is AudioSource && x.Name == "人声音频");
var 背景音频 = videoProject.MediaSource.First(x => x is AudioSource && x.Name == "背景音频");

var vadDatas = 人声音频.VadSegments; // 数据结构 VadData
```

### 缩放因子
- 默认值：1.0
- 范围：0.5x - 3.0x
- 作用：改变缩放因子可以实现元素区域的缩放

### 总时长计算
```
TotalTimeLength = 视频时长 * 缩放因子 * 100.0（像素/秒）
```

## 未来扩展
- TTS 功能
- 重新 TTS
- 手动拖拽调整片段长度
- 合并片段
- 片段编辑功能

## 文件结构
```
TimeLine/
├── Controls/
│   ├── SimpleTimeLinePanel.cs       # 主控件
│   ├── TimeLineRowControl.cs     # 行控件
│   └── WaveformControl.cs        # 波形控件
├── Models/
│   ├── TimeLineData.cs           # 数据容器
│   ├── TimeLineRow.cs            # 行数据
│   └── TimeLineItem.cs           # 片段数据
├── Services/
│   ├── IAudioPlayerService.cs    # 音频播放接口
│   ├── IWaveformService.cs       # 波形服务接口
│   └── WaveformService.cs        # 波形服务实现
├── ViewModels/
│   └── TimeLineViewModel.cs      # 视图模型
├── Converters/
│   └── ValueConverters.cs        # 值转换器
├── Themes/
│   └── Generic.xaml              # 控件样式
└── MainWindow.xaml.cs            # 主窗口
```

## 注意事项
1. **避免数据绑定导致的死循环**：使用手动控件创建的方式，而不是数据绑定
2. **使用防抖机制**：缩放和行更新操作使用防抖机制，避免频繁 UI 更新
3. **波形数据缓存**：WaveformService 实现了缓存机制，避免重复加载音频文件
4. **事件订阅时机**：确保在 UI 元素初始化完成后再订阅事件
5. **NAudio 依赖**：确保已安装 NAudio NuGet 包（版本 2.2.1 或更高）
